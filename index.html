<!DOCTYPE html>
<html>
<head>
    <title>ç‹¼ç‹—æ€æ¸¸æˆåŠ©æ‰‹</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #2c3e50; color: white; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        .room-id { background: #34495e; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .players-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin: 20px 0; }
        .player-card { background: #3498db; padding: 15px; border-radius: 10px; text-align: center; position: relative; }
        .player-card.dead { background: #7f8c8d; opacity: 0.7; }
        .player-card.challenger { background: #e74c3c; }
        .player-card.opponent { background: #f39c12; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: #ecf0f1; margin: 0 auto 10px; }
        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
        button { padding: 10px 20px; background: #2ecc71; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }
        button:disabled { background: #95a5a6; }
        .role-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .role-card { background: white; color: #2c3e50; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; }
        .role-image { width: 200px; height: 300px; background: #bdc3c7; margin: 0 auto 20px; border-radius: 10px; }
        .log { background: #1a252f; padding: 10px; border-radius: 5px; height: 200px; overflow-y: auto; margin-top: 20px; }
        .faction-badge { position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; border-radius: 50%; }
        .wolf { background: #c0392b; }
        .dog { background: #2980b9; }
        .neutral { background: #f1c40f; }
        .setup-panel { background: #34495e; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .setup-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .setup-row label { min-width: 80px; }
        input[type="number"] { width: 60px; padding: 5px; }
        .preset-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .preset-buttons button { padding: 5px 10px; background: #9b59b6; }
        .mode-selector { margin-bottom: 20px; }
        .mode-selector button { margin: 0 5px; }
        .invite-link { background: #34495e; padding: 10px; border-radius: 5px; margin: 10px 0; word-break: break-all; }
        .teammate-list { background: rgba(192, 57, 43, 0.2); padding: 10px; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨¡å¼é€‰æ‹©ï¼šæˆ¿ä¸»/ç©å®¶ -->
        <div class="mode-selector" id="modeSelector">
            <h3>é€‰æ‹©ä½ çš„èº«ä»½ï¼š</h3>
            <button onclick="setMode('host')" id="hostBtn">æˆ‘æ˜¯æˆ¿ä¸»ï¼ˆåˆ›å»ºæˆ¿é—´ï¼‰</button>
            <button onclick="setMode('player')" id="playerBtn">æˆ‘æ˜¯ç©å®¶ï¼ˆåŠ å…¥æˆ¿é—´ï¼‰</button>
        </div>

        <!-- æˆ¿ä¸»ç•Œé¢ -->
        <div id="hostView" style="display: none;">
            <div class="header">
                <h1>ğŸº ç‹¼ç‹—æ€ - æˆ¿ä¸»æ§åˆ¶å° ğŸ•</h1>
                <div class="room-id">æˆ¿é—´å·: <span id="roomCode">-</span></div>
                <div class="invite-link">åˆ†äº«é“¾æ¥ï¼š<span id="shareLink">åŠ è½½ä¸­...</span></div>
            </div>

            <div class="setup-panel">
                <h3>æ¸¸æˆè®¾ç½®</h3>
                <div class="setup-row">
                    <label>æ€»äººæ•°:</label>
                    <input type="number" id="totalPlayers" min="5" max="10" value="6">
                    <label>ç‹¼æ´¾:</label>
                    <input type="number" id="wolfCount" min="1" max="3" value="2">
                    <label>ç‹—æ´¾:</label>
                    <input type="number" id="dogCount" min="1" max="5" value="3">
                    <label>ä¸­ç«‹:</label>
                    <input type="number" id="neutralCount" min="1" max="3" value="1">
                </div>
                <div class="preset-buttons">
                    <button onclick="applyPreset('5äººå±€')">5äººå±€ (1ç‹¼3ç‹—1ä¸­)</button>
                    <button onclick="applyPreset('6äººå±€')">6äººå±€ (2ç‹¼3ç‹—1ä¸­)</button>
                    <button onclick="applyPreset('8äººå±€')">8äººå±€ (2ç‹¼4ç‹—2ä¸­)</button>
                </div>
            </div>

            <div class="controls">
                <button onclick="startGame()" id="startBtn">å¼€å§‹æ¸¸æˆ</button>
                <button onclick="kickPlayer()" id="kickBtn" disabled>ç§»é™¤ç©å®¶</button>
                <button onclick="resetRoom()">é‡ç½®æˆ¿é—´</button>
            </div>

            <h3>å·²åŠ å…¥çš„ç©å®¶ (ç‚¹å‡»ç§»é™¤)</h3>
            <div class="players-grid" id="playersGrid">
                <!-- ç©å®¶åŠ¨æ€æ·»åŠ  -->
            </div>

            <h3>æ¸¸æˆæ§åˆ¶ (å¼€å§‹åæ¿€æ´»)</h3>
            <div class="controls" id="gameControls" style="display: none;">
                <button onclick="setChallenger()" id="challengerBtn">è®¾ç½®æ“‚ä¸»</button>
                <button onclick="setOpponent()" id="opponentBtn">è®¾ç½®å¯¹æ‰‹</button>
                <button onclick="challengerWin()" id="winBtn">æ“‚ä¸»èƒœ</button>
                <button onclick="opponentWin()" id="loseBtn">å¯¹æ‰‹èƒœ</button>
            </div>

            <h3>æ¸¸æˆæ—¥å¿—</h3>
            <div class="log" id="gameLog">
                <div>ç­‰å¾…ç©å®¶åŠ å…¥...</div>
            </div>
        </div>

        <!-- ç©å®¶ç•Œé¢ -->
        <div id="playerView" style="display: none;">
            <div class="header">
                <h1>ğŸº ç‹¼ç‹—æ€ - ç©å®¶ç•Œé¢ ğŸ•</h1>
                <div class="room-id">æˆ¿é—´å·: <span id="playerRoomCode">-</span></div>
                <div>æˆ¿ä¸»: <span id="hostName">-</span></div>
            </div>

            <div class="setup-panel" id="joinPanel">
                <h3>åŠ å…¥æˆ¿é—´</h3>
                <div class="setup-row">
                    <label>æˆ¿é—´å·:</label>
                    <input type="text" id="inputRoomCode" placeholder="è¾“å…¥æˆ¿ä¸»åˆ†äº«çš„6ä½ä»£ç ">
                    <button onclick="joinRoom()">åŠ å…¥</button>
                </div>
                <div class="setup-row">
                    <label>ä½ çš„åå­—:</label>
                    <input type="text" id="playerName" placeholder="è¾“å…¥ä½ çš„æ˜µç§°" value="ç©å®¶">
                </div>
            </div>

            <div id="gameArea" style="display: none;">
                <h3>ç©å®¶åˆ—è¡¨</h3>
                <div class="players-grid" id="playerPlayersGrid">
                    <!-- ç©å®¶åŠ¨æ€æ·»åŠ  -->
                </div>

                <div id="myRoleArea" style="display: none;">
                    <h3>æˆ‘çš„è§’è‰²</h3>
                    <div class="role-card" style="background: white; color: #2c3e50; padding: 15px; border-radius: 10px;">
                        <h2 id="myRoleName">-</h2>
                        <p id="myRoleFaction">é˜µè¥ï¼š-</p>
                        <p id="myRoleSkill">æŠ€èƒ½ï¼š-</p>
                        <button onclick="showRoleDetail()">æŸ¥çœ‹è¯¦æƒ…</button>
                    </div>
                </div>

                <!-- ç‹¼äººé˜Ÿå‹åˆ—è¡¨ -->
                <div id="teammatesArea" style="display: none;" class="teammate-list">
                    <h3>ğŸº ç‹¼é˜Ÿå‹</h3>
                    <div id="teammatesList"></div>
                </div>

                <h3>æ¸¸æˆçŠ¶æ€</h3>
                <div class="log" id="playerGameLog">
                    <div>ç­‰å¾…æ¸¸æˆå¼€å§‹...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- è§’è‰²è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="role-modal" id="roleModal" style="display: none;">
        <div class="role-card">
            <div class="role-image" id="roleImg"></div>
            <h2 id="roleName">è§’è‰²åç§°</h2>
            <p id="roleFaction">é˜µè¥ï¼š</p>
            <p id="roleSkill">æŠ€èƒ½ï¼š</p>
            <button onclick="closeRoleModal()" style="margin-top: 20px;">å…³é—­</button>
        </div>
    </div>

    <script>
        // ==================== æ ¸å¿ƒæ•°æ® ====================
        const GameApp = {
            mode: null, // 'host' æˆ– 'player'
            roomId: null,
            userId: 'user_' + Math.random().toString(36).substr(2, 9),
            userName: 'ç©å®¶',
            isHost: false,
            gameStarted: false,
            players: [],
            myRole: null
        };

        // è§’è‰²æ± ï¼ˆç®€åŒ–ç‰ˆï¼‰
        const ROLES = {
            wolf: ['å¤§å“¥', 'æ å¤ºè€…', 'è”¡æ–‡å§¬', 'æš—æ€è€…', 'æˆ˜æœ¯å®¶', 'å¤ä»‡è€…'],
            dog: ['é¾Ÿç”·', 'æŠ¤å£«', 'ç”°å›­å¥³æ‹³', 'é˜¿å‘', 'ç¼šçµè€…', 'åŒå­åº§', 'æ•å¿«', 'å…ˆé©±', 'çŒäºº'],
            neutral: ['å°ä¸‘', 'å‘†å‘†é¸Ÿ', 'ç»¿èŒ¶', 'å¢æœ¬ä¼Ÿ']
        };

        // ==================== æœ¬åœ°å­˜å‚¨æ¨¡æ‹Ÿ"æˆ¿é—´" ====================
        // ä½¿ç”¨ localStorage æ¨¡æ‹Ÿå…±äº«çŠ¶æ€ï¼ˆå®é™…å¤šäººæ—¶æ— æ•ˆï¼Œä½†åŒä¸€è®¾å¤‡å¤šæ ‡ç­¾é¡µå¯æµ‹è¯•ï¼‰
        // æ³¨æ„ï¼šçœŸå®å¤šäººéœ€è¦åç«¯ï¼Œè¿™é‡Œå…ˆåšæœ¬åœ°æµ‹è¯•ç‰ˆ

        // æˆ¿é—´ç®¡ç†å™¨
        const RoomManager = {
            // åˆ›å»ºæˆ¿é—´
            createRoom() {
                const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
                const room = {
                    id: roomId,
                    hostId: GameApp.userId,
                    hostName: GameApp.userName,
                    players: [{
                        id: GameApp.userId,
                        name: GameApp.userName,
                        isHost: true
                    }],
                    settings: {
                        totalPlayers: 6,
                        wolf: 2,
                        dog: 3,
                        neutral: 1
                    },
                    gameState: {
                        started: false,
                        challenger: null,
                        opponent: null,
                        eliminated: []
                    },
                    logs: [`æˆ¿é—´åˆ›å»ºäº ${new Date().toLocaleTimeString()}`]
                };
                
                localStorage.setItem('room_' + roomId, JSON.stringify(room));
                return roomId;
            },

            // åŠ å…¥æˆ¿é—´
            joinRoom(roomId) {
                const roomData = localStorage.getItem('room_' + roomId);
                if (!roomData) {
                    alert('æˆ¿é—´ä¸å­˜åœ¨ï¼');
                    return false;
                }
                
                const room = JSON.parse(roomData);
                
                // æ£€æŸ¥æ˜¯å¦å·²åœ¨æˆ¿é—´ä¸­
                if (room.players.some(p => p.id === GameApp.userId)) {
                    alert('ä½ å·²ç»åœ¨æˆ¿é—´ä¸­äº†ï¼');
                    return true;
                }
                
                // æ·»åŠ ç©å®¶
                room.players.push({
                    id: GameApp.userId,
                    name: GameApp.userName,
                    isHost: false
                });
                
                room.logs.push(`${GameApp.userName} åŠ å…¥äº†æˆ¿é—´`);
                localStorage.setItem('room_' + roomId, JSON.stringify(room));
                return true;
            },

            // è·å–æˆ¿é—´æ•°æ®
            getRoom(roomId) {
                const data = localStorage.getItem('room_' + roomId);
                return data ? JSON.parse(data) : null;
            },

            // æ›´æ–°æˆ¿é—´
            updateRoom(roomId, updates) {
                const room = this.getRoom(roomId);
                if (!room) return false;
                
                Object.assign(room, updates);
                localStorage.setItem('room_' + roomId, JSON.stringify(room));
                return true;
            }
        };

        // ==================== ç•Œé¢åŠŸèƒ½ ====================

        // è®¾ç½®æ¨¡å¼
        function setMode(mode) {
            GameApp.mode = mode;
            GameApp.isHost = (mode === 'host');
            
            document.getElementById('modeSelector').style.display = 'none';
            
            if (mode === 'host') {
                document.getElementById('hostView').style.display = 'block';
                createRoom();
            } else {
                document.getElementById('playerView').style.display = 'block';
                document.getElementById('playerName').value = GameApp.userName;
            }
        }

        // åˆ›å»ºæˆ¿é—´
        function createRoom() {
            GameApp.roomId = RoomManager.createRoom();
            GameApp.userName = prompt('è¯·è¾“å…¥æˆ¿ä¸»æ˜µç§°:', 'æˆ¿ä¸»') || 'æˆ¿ä¸»';
            
            document.getElementById('roomCode').textContent = GameApp.roomId;
            document.getElementById('shareLink').textContent = window.location.href.split('?')[0] + '?room=' + GameApp.roomId;
            
            updateHostView();
            startPolling();
            
            logMessage('æˆ¿é—´åˆ›å»ºæˆåŠŸï¼åˆ†äº«é“¾æ¥ç»™æœ‹å‹åŠ å…¥ã€‚');
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            const roomId = document.getElementById('inputRoomCode').value.trim().toUpperCase();
            GameApp.userName = document.getElementById('playerName').value || 'ç©å®¶';
            
            if (!roomId || roomId.length !== 6) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½æˆ¿é—´å·');
                return;
            }
            
            if (RoomManager.joinRoom(roomId)) {
                GameApp.roomId = roomId;
                document.getElementById('playerRoomCode').textContent = roomId;
                document.getElementById('joinPanel').style.display = 'none';
                document.getElementById('gameArea').style.display = 'block';
                
                updatePlayerView();
                startPolling();
                
                logPlayerMessage('å·²åŠ å…¥æˆ¿é—´ï¼ç­‰å¾…æˆ¿ä¸»å¼€å§‹æ¸¸æˆ...');
            }
        }

        // æ›´æ–°æˆ¿ä¸»ç•Œé¢
        function updateHostView() {
            const room = RoomManager.getRoom(GameApp.roomId);
            if (!room) return;
            
            // æ›´æ–°ç©å®¶åˆ—è¡¨
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';
            
            room.players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.innerHTML = `
                    <div class="avatar"></div>
                    <div>${player.name} ${player.isHost ? 'ğŸ‘‘' : ''}</div>
                    <div style="font-size:11px;margin-top:5px;">${player.id === GameApp.userId ? 'ï¼ˆæˆ‘ï¼‰' : ''}</div>
                `;
                
                if (!player.isHost) {
                    card.onclick = () => kickPlayer(player.id);
                    card.title = 'ç‚¹å‡»ç§»é™¤ç©å®¶';
                }
                
                grid.appendChild(card);
            });
            
            // æ›´æ–°æ—¥å¿—
            const logDiv = document.getElementById('gameLog');
            logDiv.innerHTML = '';
            room.logs.forEach(log => {
                const entry = document.createElement('div');
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${log}`;
                logDiv.appendChild(entry);
            });
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // æ›´æ–°æ¸¸æˆæ§åˆ¶æ˜¾ç¤º
            document.getElementById('gameControls').style.display = room.gameState.started ? 'block' : 'none';
            document.getElementById('startBtn').disabled = room.gameState.started;
        }

        // æ›´æ–°ç©å®¶ç•Œé¢
        function updatePlayerView() {
            const room = RoomManager.getRoom(GameApp.roomId);
            if (!room) return;
            
            // æ›´æ–°æˆ¿ä¸»åå­—
            const host = room.players.find(p => p.isHost);
            if (host) {
                document.getElementById('hostName').textContent = host.name;
            }
            
            // æ›´æ–°ç©å®¶åˆ—è¡¨
            const grid = document.getElementById('playerPlayersGrid');
            grid.innerHTML = '';
            
            room.players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                if (room.gameState.eliminated.includes(player.id)) {
                    card.classList.add('dead');
                }
                if (player.id === room.gameState.challenger) {
                    card.classList.add('challenger');
                }
                if (player.id === room.gameState.opponent) {
                    card.classList.add('opponent');
                }
                
                card.innerHTML = `
                    <div class="avatar"></div>
                    <div>${player.name} ${player.isHost ? 'ğŸ‘‘' : ''}</div>
                    <div style="font-size:11px;margin-top:5px;">
                        ${room.gameState.eliminated.includes(player.id) ? 'âŒæ·˜æ±°' : 'âœ…å­˜æ´»'}
                    </div>
                `;
                grid.appendChild(card);
            });
            
            // å¦‚æœæ¸¸æˆå·²å¼€å§‹ï¼Œæ˜¾ç¤ºè§’è‰²ä¿¡æ¯
            if (room.gameState.started && GameApp.myRole) {
                document.getElementById('myRoleArea').style.display = 'block';
                document.getElementById('myRoleName').textContent = GameApp.myRole.name;
                document.getElementById('myRoleFaction').textContent = `é˜µè¥ï¼š${GameApp.myRole.faction === 'wolf' ? 'ç‹¼æ´¾' : GameApp.myRole.faction === 'dog' ? 'ç‹—æ´¾' : 'ä¸­ç«‹'}`;
                document.getElementById('myRoleSkill').textContent = `æŠ€èƒ½ï¼š${GameApp.myRole.skill || 'æ— ç‰¹æ®ŠæŠ€èƒ½'}`;
                
                // å¦‚æœæ˜¯ç‹¼äººï¼Œæ˜¾ç¤ºé˜Ÿå‹
                if (GameApp.myRole.faction === 'wolf' && room.gameState.roles) {
                    const wolfTeammates = room.players.filter(p => 
                        p.id !== GameApp.userId && 
                        room.gameState.roles[p.id] && 
                        room.gameState.roles[p.id].faction === 'wolf'
                    );
                    
                    if (wolfTeammates.length > 0) {
                        document.getElementById('teammatesArea').style.display = 'block';
                        const list = document.getElementById('teammatesList');
                        list.innerHTML = '';
                        wolfTeammates.forEach(teammate => {
                            const role = room.gameState.roles[teammate.id];
                            const div = document.createElement('div');
                            div.textContent = `${teammate.name} - ${role.name}`;
                            list.appendChild(div);
                        });
                    }
                }
            }
            
            // æ›´æ–°æ—¥å¿—
            const logDiv = document.getElementById('playerGameLog');
            logDiv.innerHTML = '';
            room.logs.forEach(log => {
                const entry = document.createElement('div');
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${log}`;
                logDiv.appendChild(entry);
            });
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // å¼€å§‹æ¸¸æˆï¼ˆæˆ¿ä¸»ï¼‰
        function startGame() {
            const room = RoomManager.getRoom(GameApp.roomId);
            if (!room) return;
            
            // è¯»å–è®¾ç½®
            room.settings = {
                totalPlayers: parseInt(document.getElementById('totalPlayers').value) || 6,
                wolf: parseInt(document.getElementById('wolfCount').value) || 2,
                dog: parseInt(document.getElementById('dogCount').value) || 3,
                neutral: parseInt(document.getElementById('neutralCount').value) || 1
            };
            
            // æ£€æŸ¥äººæ•°
            if (room.players.length < room.settings.totalPlayers) {
                alert(`éœ€è¦è‡³å°‘${room.settings.totalPlayers}äººæ‰èƒ½å¼€å§‹æ¸¸æˆï¼Œå½“å‰åªæœ‰${room.players.length}äºº`);
                return;
            }
            
            // åˆ†é…è§’è‰²
            const roles = assignRoles(room);
            room.gameState.started = true;
            room.gameState.roles = roles;
            room.logs.push('æ¸¸æˆå¼€å§‹ï¼è§’è‰²å·²åˆ†é…ã€‚');
            
            RoomManager.updateRoom(GameApp.roomId, room);
            
            // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œä¹Ÿç»™è‡ªå·±åˆ†é…è§’è‰²
            if (GameApp.isHost) {
                GameApp.myRole = roles[GameApp.userId];
            }
            
            updateHostView();
        }

        // åˆ†é…è§’è‰²
        function assignRoles(room) {
            const roles = {};
            const players = [...room.players];
            
            // å‡†å¤‡è§’è‰²æ± 
            const wolfRoles = [...ROLES.wolf];
            const dogRoles = [...ROLES.dog];
            const neutralRoles = [...ROLES.neutral];
            
            // æ‰“ä¹±é¡ºåº
            const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);
            shuffle(wolfRoles);
            shuffle(dogRoles);
            shuffle(neutralRoles);
            
            // åˆ†é…ç‹¼æ´¾
            for (let i = 0; i < room.settings.wolf && wolfRoles.length > 0; i++) {
                const player = players.shift();
                if (player) {
                    roles[player.id] = {
                        name: wolfRoles.shift(),
                        faction: 'wolf',
                        skill: 'ç‹¼æ´¾æŠ€èƒ½'
                    };
                }
            }
            
            // åˆ†é…ç‹—æ´¾
            for (let i = 0; i < room.settings.dog && dogRoles.length > 0; i++) {
                const player = players.shift();
                if (player) {
                    roles[player.id] = {
                        name: dogRoles.shift(),
                        faction: 'dog',
                        skill: 'ç‹—æ´¾æŠ€èƒ½'
                    };
                }
            }
            
            // åˆ†é…ä¸­ç«‹
            for (let i = 0; i < room.settings.neutral && neutralRoles.length > 0; i++) {
                const player = players.shift();
                if (player) {
                    roles[player.id] = {
                        name: neutralRoles.shift(),
                        faction: 'neutral',
                        skill: 'ä¸­ç«‹æŠ€èƒ½'
                    };
                }
            }
            
            // å‰©ä¸‹çš„ç©å®¶åˆ†é…å‰©ä½™è§’è‰²
            const remainingPlayers = players;
            const allRoles = [...wolfRoles, ...dogRoles, ...neutralRoles];
            shuffle(allRoles);
            
            remainingPlayers.forEach((player, index) => {
                if (index < allRoles.length) {
                    const roleName = allRoles[index];
                    const faction = ROLES.wolf.includes(roleName) ? 'wolf' : 
                                   ROLES.dog.includes(roleName) ? 'dog' : 'neutral';
                    roles[player.id] = {
                        name: roleName,
                        faction: faction,
                        skill: `${faction}æŠ€èƒ½`
                    };
                }
            });
            
            return roles;
        }

        // åº”ç”¨é¢„è®¾
        function applyPreset(presetName) {
            const presets = {
                '5äººå±€': { total: 5, wolf: 1, dog: 3, neutral: 1 },
                '6äººå±€': { total: 6, wolf: 2, dog: 3, neutral: 1 },
                '8äººå±€': { total: 8, wolf: 2, dog: 4, neutral: 2 }
            };
            
            const preset = presets[presetName];
            if (preset) {
                document.getElementById('totalPlayers').value = preset.total;
                document.getElementById('wolfCount').value = preset.wolf;
                document.getElementById('dogCount').value = preset.dog;
                document.getElementById('neutralCount').value = preset.neutral;
                logMessage(`å·²åº”ç”¨${presetName}é…ç½®`);
            }
        }

        // ç§»é™¤ç©å®¶
        function kickPlayer(playerId) {
            if (!playerId) {
                // å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œè®©æˆ¿ä¸»é€‰æ‹©
                const room = RoomManager.getRoom(GameApp.roomId);
                const nonHostPlayers = room.players.filter(p => !p.isHost);
                if (nonHostPlayers.length === 0) {
                    alert('æ²¡æœ‰å¯ä»¥ç§»é™¤çš„ç©å®¶');
                    return;
                }
                
                const playerName = prompt(`è¾“å…¥è¦ç§»é™¤çš„ç©å®¶åå­—ï¼š\n${nonHostPlayers.map(p => p.name).join(', ')}`);
                const player = nonHostPlayers.find(p => p.name === playerName);
                if (player) {
                    playerId = player.id;
                } else {
                    return;
                }
            }
            
            const room = RoomManager.getRoom(GameApp.roomId);
            room.players = room.players.filter(p => p.id !== playerId);
            room.logs.push(`ç©å®¶å·²è¢«ç§»é™¤`);
            RoomManager.updateRoom(GameApp.roomId, room);
            updateHostView();
        }

        // è½®è¯¢æ›´æ–°ï¼ˆæ¨¡æ‹Ÿå®æ—¶ï¼‰
        function startPolling() {
            if (GameApp.pollInterval) clearInterval(GameApp.pollInterval);
            
            GameApp.pollInterval = setInterval(() => {
                if (GameApp.isHost) {
                    updateHostView();
                } else {
                    updatePlayerView();
                    
                    // å¦‚æœæ˜¯ç©å®¶ï¼Œæ£€æŸ¥æ˜¯å¦åˆ†é…äº†è§’è‰²
                    const room = RoomManager.getRoom(GameApp.roomId);
                    if (room && room.gameState.started && room.gameState.roles && !GameApp.myRole) {
                        GameApp.myRole = room.gameState.roles[GameApp.userId];
                        if (GameApp.myRole) {
                            logPlayerMessage(`ä½ çš„è§’è‰²ï¼š${GameApp.myRole.name} (${GameApp.myRole.faction === 'wolf' ? 'ç‹¼æ´¾' : GameApp.myRole.faction === 'dog' ? 'ç‹—æ´¾' : 'ä¸­ç«‹'})`);
                        }
                    }
                }
            }, 2000);
        }

        // æ—¥å¿—å‡½æ•°
        function logMessage(msg) {
            const room = RoomManager.getRoom(GameApp.roomId);
            if (room) {
                room.logs.push(msg);
                RoomManager.updateRoom(GameApp.roomId, room);
            }
        }

        function logPlayerMessage(msg) {
            console.log(msg);
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeRoleModal() {
            document.getElementById('roleModal').style.display = 'none';
        }

        // æ˜¾ç¤ºè§’è‰²è¯¦æƒ…
        function showRoleDetail() {
            if (!GameApp.myRole) return;
            
            document.getElementById('roleName').textContent = GameApp.myRole.name;
            document.getElementById('roleFaction').textContent = `é˜µè¥ï¼š${GameApp.myRole.faction === 'wolf' ? 'ç‹¼æ´¾' : GameApp.myRole.faction === 'dog' ? 'ç‹—æ´¾' : 'ä¸­ç«‹'}`;
            document.getElementById('roleSkill').textContent = `æŠ€èƒ½ï¼š${GameApp.myRole.skill}`;
            document.getElementById('roleImg').style.background = GameApp.myRole.faction === 'wolf' ? '#c0392b' : GameApp.myRole.faction === 'dog' ? '#2980b9' : '#f1c40f';
            
            document.getElementById('roleModal').style.display = 'flex';
        }

        // æ¸¸æˆæ§åˆ¶å‡½æ•°ï¼ˆç®€åŒ–çš„ï¼‰
        function setChallenger() {
            const room = RoomManager.getRoom(GameApp.roomId);
            const alivePlayers = room.players.filter(p => !room.gameState.eliminated.includes(p.id));
            
            if (alivePlayers.length === 0) return;
            
            const playerName = prompt(`è®¾ç½®æ“‚ä¸»ï¼š\n${alivePlayers.map(p => p.name).join(', ')}`);
            const player = alivePlayers.find(p => p.name === playerName);
            if (player) {
                room.gameState.challenger = player.id;
                room.logs.push(`${player.name} æˆä¸ºæ“‚ä¸»`);
                RoomManager.updateRoom(GameApp.roomId, room);
            }
        }

        function setOpponent() {
            const room = RoomManager.getRoom(GameApp.roomId);
            if (!room.gameState.challenger) {
                alert('è¯·å…ˆè®¾ç½®æ“‚ä¸»');
                return;
            }
            
            const alivePlayers = room.players.filter(p => 
                p.id !== room.gameState.challenger && 
                !room.gameState.eliminated.includes(p.id)
            );
            
            if (alivePlayers.length === 0) return;
            
            const playerName = prompt(`è®¾ç½®å¯¹æ‰‹ï¼š\n${alivePlayers.map(p => p.name).join(', ')}`);
            const player = alivePlayers.find(p => p.name === playerName);
            if (player) {
                room.gameState.opponent = player.id;
                room.logs.push(`æ“‚ä¸» ${room.players.find(p => p.id === room.gameState.challenger).name} VS ${player.name}`);
                RoomManager.updateRoom(GameApp.roomId, room);
            }
        }

        function challengerWin() {
            const room = RoomManager.getRoom(GameApp.roomId);
            if (!room.gameState.challenger || !room.gameState.opponent) {
                alert('è¯·å…ˆè®¾ç½®æ“‚ä¸»å’Œå¯¹æ‰‹');
                return;
            }
            
            const opponent = room.players.find(p => p.id === room.gameState.opponent);
            room.gameState.eliminated.push(room.gameState.opponent);
            room.gameState.opponent = null;
            room.logs.push(`æ“‚ä¸»èƒœï¼${opponent.name} è¢«æ·˜æ±°`);
            RoomManager.updateRoom(GameApp.roomId, room);
        }

        function opponentWin() {
            const room = RoomManager.getRoom(GameApp.roomId);
            if (!room.gameState.challenger || !room.gameState.opponent) {
                alert('è¯·å…ˆè®¾ç½®æ“‚ä¸»å’Œå¯¹æ‰‹');
                return;
            }
            
            const challenger = room.players.find(p => p.id === room.gameState.challenger);
            const opponent = room.players.find(p => p.id === room.gameState.opponent);
            
            room.gameState.eliminated.push(room.gameState.challenger);
            room.gameState.challenger = room.gameState.opponent;
            room.gameState.opponent = null;
            room.logs.push(`å¯¹æ‰‹èƒœï¼${challenger.name} è¢«æ·˜æ±°ï¼Œ${opponent.name} æˆä¸ºæ–°æ“‚ä¸»`);
            RoomManager.updateRoom(GameApp.roomId, room);
        }

        // é‡ç½®æˆ¿é—´
        function resetRoom() {
            if (confirm('ç¡®å®šè¦é‡ç½®æˆ¿é—´å—ï¼Ÿæ‰€æœ‰ç©å®¶å°†è¢«ç§»é™¤ã€‚')) {
                localStorage.removeItem('room_' + GameApp.roomId);
                location.reload();
            }
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            // æ£€æŸ¥URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            
            if (roomParam) {
                // å¦‚æœæœ‰æˆ¿é—´å‚æ•°ï¼Œè‡ªåŠ¨è¿›å…¥ç©å®¶æ¨¡å¼
                document.getElementById('inputRoomCode').value = roomParam;
                setTimeout(() => {
                    setMode('player');
                }, 100);
            }
        };
    </script>
</body>
</html>
