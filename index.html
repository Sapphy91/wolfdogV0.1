<!DOCTYPE html>
<html>
<head>
    <title>ç‹¼ç‹—æ€æ¸¸æˆåŠ©æ‰‹</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #2c3e50; color: white; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        .room-id { background: #34495e; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .players-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin: 20px 0; }
        .player-card { background: #3498db; padding: 15px; border-radius: 10px; text-align: center; position: relative; min-height: 120px; }
        .player-card.empty { background: #2c3e50; border: 2px dashed #7f8c8d; }
        .player-card.dead { background: #7f8c8d; opacity: 0.7; }
        .player-card.challenger { background: #e74c3c; }
        .player-card.opponent { background: #f39c12; }
        .player-card.self { border: 3px solid #2ecc71; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #ecf0f1; margin: 0 auto 10px; }
        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
        button { padding: 10px 20px; background: #2ecc71; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }
        button:disabled { background: #95a5a6; }
        button.small { padding: 5px 10px; font-size: 12px; }
        .settings { background: #34495e; padding: 15px; border-radius: 10px; margin: 20px 0; }
        .setting-item { margin: 10px 0; }
        .setting-item label { display: inline-block; width: 150px; }
        .setting-item input { padding: 5px; width: 60px; }
        .log { background: #1a252f; padding: 10px; border-radius: 5px; height: 200px; overflow-y: auto; margin-top: 20px; }
        .faction-badge { position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; border-radius: 50%; }
        .wolf { background: #c0392b; }
        .dog { background: #2980b9; }
        .neutral { background: #f1c40f; }
        .role-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .role-card { background: white; color: #2c3e50; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; width: 90%; }
        .role-image { width: 200px; height: 300px; background: #bdc3c7; margin: 0 auto 20px; border-radius: 10px; }
        .tab-container { display: flex; border-bottom: 1px solid #7f8c8d; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: #2ecc71; }
    </style>
</head>
<body>
    <div class="tab-container">
        <div class="tab active" onclick="switchTab('host')">æˆ¿ä¸»ç•Œé¢</div>
        <div class="tab" onclick="switchTab('player')">ç©å®¶ç•Œé¢</div>
        <div class="tab" onclick="switchTab('admin')">ç®¡ç†ç•Œé¢</div>
    </div>

    <!-- æˆ¿ä¸»ç•Œé¢ -->
    <div id="host-tab" class="tab-content">
        <div class="header">
            <h1>ğŸº ç‹¼ç‹—æ€ - æˆ¿ä¸»æ§åˆ¶å° ğŸ•</h1>
            <div class="room-id">æˆ¿é—´å·: <span id="roomCode">WD-2024</span> | åˆ†äº«é“¾æ¥: <input type="text" id="roomLink" value="" readonly style="width: 300px;"> <button class="small" onclick="copyLink()">å¤åˆ¶é“¾æ¥</button></div>
            <div>æˆ¿ä¸»: <span id="hostName">ä½ </span></div>
        </div>

        <div class="settings">
            <h3>æ¸¸æˆè®¾ç½®</h3>
            <div class="setting-item">
                <label>æ€»ç©å®¶æ•°:</label>
                <input type="number" id="totalPlayers" min="5" max="10" value="6" onchange="updatePlayerSlots()">
            </div>
            <div class="setting-item">
                <label>ç‹¼æ´¾äººæ•°:</label>
                <input type="number" id="wolfCount" min="1" max="3" value="2">
            </div>
            <div class="setting-item">
                <label>ç‹—æ´¾äººæ•°:</label>
                <input type="number" id="dogCount" min="3" max="5" value="3">
            </div>
            <div class="setting-item">
                <label>ä¸­ç«‹äººæ•°:</label>
                <input type="number" id="neutralCount" min="1" max="2" value="1">
            </div>
            <div class="setting-item">
                <button onclick="applyPreset('6äººç»å…¸')">6äººç»å…¸é…ç½®</button>
                <button onclick="applyPreset('8äººå±€')">8äººå±€</button>
                <button onclick="applyPreset('10äººå±€')">10äººå±€</button>
            </div>
        </div>

        <div class="controls">
            <button onclick="startGame()" id="startBtn">å¼€å§‹æ¸¸æˆ</button>
            <button onclick="setChallenger()" id="challengerBtn" disabled>è®¾ç½®æ“‚ä¸»</button>
            <button onclick="setOpponent()" id="opponentBtn" disabled>è®¾ç½®å¯¹æ‰‹</button>
            <button onclick="challengerWins()" id="winBtn" disabled>æ“‚ä¸»èƒœåˆ©</button>
            <button onclick="opponentWins()" id="loseBtn" disabled>å¯¹æ‰‹èƒœåˆ©</button>
            <button onclick="resetGame()">é‡æ–°å¼€å§‹</button>
        </div>

        <h3>ç©å®¶åˆ—è¡¨ (ç‚¹å‡»å¤´åƒè®¾ç½®çŠ¶æ€)</h3>
        <div class="players-grid" id="hostPlayersGrid">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <h3>æ¸¸æˆçŠ¶æ€</h3>
        <div class="log" id="gameLog">
            <div>ç­‰å¾…æ¸¸æˆå¼€å§‹...</div>
        </div>
    </div>

    <!-- ç©å®¶ç•Œé¢ -->
    <div id="player-tab" class="tab-content" style="display: none;">
        <div class="header">
            <h1>ğŸº ç‹¼ç‹—æ€ - ç©å®¶ç•Œé¢ ğŸ•</h1>
            <div>æˆ¿é—´å·: <span id="playerRoomCode">WD-2024</span></div>
            <div>ç©å®¶: <span id="playerName">æœªåŠ å…¥</span></div>
        </div>

        <div id="playerWaiting">
            <h3>ç­‰å¾…æˆ¿é—´</h3>
            <p>ç­‰å¾…æˆ¿ä¸»å¼€å§‹æ¸¸æˆ...</p>
            <div class="players-grid" id="playerWaitingGrid">
                <!-- ç©å®¶åˆ—è¡¨ -->
            </div>
        </div>

        <div id="playerGame" style="display: none;">
            <h3>ä½ çš„èº«ä»½</h3>
            <div class="player-card self">
                <div class="avatar"></div>
                <div id="myName">ç©å®¶</div>
                <div id="myRole">è§’è‰²: ç­‰å¾…åˆ†é…</div>
                <div id="myFaction">é˜µè¥: ç­‰å¾…åˆ†é…</div>
                <div id="myStatus">çŠ¶æ€: å­˜æ´»</div>
            </div>

            <button onclick="viewMyCard()" style="margin: 10px 0;">æŸ¥çœ‹æˆ‘çš„è§’è‰²å¡</button>

            <h3>ç‹¼é˜Ÿå‹ (ä»…ç‹¼æ´¾å¯è§)</h3>
            <div class="players-grid" id="wolfTeammatesGrid" style="display: none;">
                <!-- ç‹¼é˜Ÿå‹åˆ—è¡¨ -->
            </div>

            <h3>å­˜æ´»ç©å®¶</h3>
            <div class="players-grid" id="playerAliveGrid">
                <!-- å­˜æ´»ç©å®¶åˆ—è¡¨ -->
            </div>

            <h3>æ·˜æ±°ç©å®¶</h3>
            <div class="players-grid" id="playerDeadGrid">
                <!-- æ·˜æ±°ç©å®¶åˆ—è¡¨ -->
            </div>

            <h3>æˆ˜æ–—è®°å½•</h3>
            <div class="log" id="playerLog">
                <!-- ä¸æˆ¿ä¸»åŒæ­¥ -->
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜ç•Œé¢ -->
    <div id="admin-tab" class="tab-content" style="display: none;">
        <div class="header">
            <h1>ğŸº ç‹¼ç‹—æ€ - ç®¡ç†åå° ğŸ•</h1>
            <div>ç®¡ç†å‘˜: admin</div>
            <button onclick="saveAdminData()" style="background: #9b59b6;">ä¿å­˜ä¿®æ”¹</button>
        </div>

        <div class="settings">
            <h3>è§’è‰²ç®¡ç†</h3>
            <div id="rolesList">
                <!-- è§’è‰²åˆ—è¡¨ -->
            </div>
            <button onclick="addNewRole()">æ·»åŠ æ–°è§’è‰²</button>

            <h3>æ¸¸æˆèƒŒæ™¯</h3>
            <div>
                <input type="text" id="bgImageUrl" placeholder="èƒŒæ™¯å›¾URL" style="width: 300px;">
                <button onclick="previewBg()">é¢„è§ˆ</button>
            </div>

            <h3>éŸ³æ•ˆç®¡ç†</h3>
            <div>
                <label>æ¸¸æˆå¼€å§‹éŸ³æ•ˆ:</label>
                <input type="text" id="soundStart" placeholder="éŸ³æ•ˆURL">
            </div>
        </div>
    </div>

    <!-- è§’è‰²å¡ç‰‡æ¨¡æ€æ¡† -->
    <div class="role-modal" id="roleModal" style="display: none;">
        <div class="role-card">
            <div class="role-image" id="roleImg"></div>
            <h2 id="roleName">è§’è‰²åç§°</h2>
            <p id="roleFaction">é˜µè¥ï¼š</p>
            <p id="roleSkill">æŠ€èƒ½ï¼š</p>
            <button onclick="closeRoleModal()" style="margin-top: 20px;">å…³é—­</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ ¸å¿ƒæ•°æ®
        const gameData = {
            roomId: 'WD-' + Date.now().toString().slice(-4),
            hostId: 'host_' + Math.random().toString(36).substr(2, 9),
            players: [],
            settings: {
                totalPlayers: 6,
                wolfCount: 2,
                dogCount: 3,
                neutralCount: 1
            },
            gameStarted: false,
            challenger: null,
            opponent: null,
            log: []
        };

        // è§’è‰²æ± 
        const rolePool = [
            // ç‹¼æ´¾
            { id: 1, name: 'å¤§å“¥', faction: 'wolf', skill: 'çŒœç èƒœåˆ©æ—¶è´¥è€…å–ä¸€æ¯ï¼Œè¿ç»­ä¸¤èƒœç›´æ¥å‡»æ€ä¸€åç©å®¶', color: '#c0392b' },
            { id: 2, name: 'æ å¤ºè€…', faction: 'wolf', skill: 'ç¬¬ä¸€æ¬¡èƒœåˆ©åç»§ç»­çŒœç ï¼Œè¿èƒœåˆ™æ·˜æ±°å¯¹æ–¹å¹¶å¤ºå–æŠ€èƒ½', color: '#c0392b' },
            { id: 3, name: 'æš—æ€è€…', faction: 'wolf', skill: 'èƒœåˆ©æ—¶æ·˜æ±°å¯¹æ‰‹ä¸”ä¸äº®èº«ä»½ç‰Œ', color: '#c0392b' },
            { id: 4, name: 'è”¡æ–‡å§¬', faction: 'wolf', skill: 'å¤±è´¥æ—¶ä»¤å¯¹æ‰‹æŠ€èƒ½æ°¸ä¹…å¤±æ•ˆ', color: '#c0392b' },
            // ç‹—æ´¾
            { id: 5, name: 'é¾Ÿç”·', faction: 'dog', skill: 'å¤±è´¥æ—¶ç»™å¯¹æ‰‹ä¸€æ¬¡å…æ­»æœºä¼š', color: '#2980b9' },
            { id: 6, name: 'æŠ¤å£«', faction: 'dog', skill: 'ä»»æ„ç©å®¶è¢«æ·˜æ±°æ—¶å¯é€‰æ‹©å¤æ´»', color: '#2980b9' },
            { id: 7, name: 'å…ˆé©±', faction: 'dog', skill: 'é¦–ä»»æ“‚ä¸»ï¼Œå¯æŸ¥éªŒä¸€äººé˜µè¥', color: '#2980b9' },
            { id: 8, name: 'çŒäºº', faction: 'dog', skill: 'è¢«æ·˜æ±°æ—¶æŒ‡å®šä¸€åç©å®¶ä¸€åŒæ·˜æ±°', color: '#2980b9' },
            // ä¸­ç«‹
            { id: 9, name: 'å‘†å‘†é¸Ÿ', faction: 'neutral', skill: 'ç¬¬ä¸€ä¸ªè¢«æ·˜æ±°ç›´æ¥è·èƒœ', color: '#f1c40f' },
            { id: 10, name: 'å°ä¸‘', faction: 'neutral', skill: 'é¦–æ¬¡çŒœç èƒœè´Ÿåè½¬', color: '#f1c40f' }
        ];

        // åˆå§‹åŒ–
        function init() {
            // ç”Ÿæˆæˆ¿é—´é“¾æ¥
            const link = window.location.href.split('?')[0] + '?room=' + gameData.roomId;
            document.getElementById('roomLink').value = link;
            document.getElementById('roomCode').textContent = gameData.roomId;
            document.getElementById('playerRoomCode').textContent = gameData.roomId;

            // åˆå§‹åŒ–ç©å®¶åˆ—è¡¨ï¼ˆåªæœ‰æˆ¿ä¸»è‡ªå·±ï¼‰
            gameData.players = [
                { 
                    id: gameData.hostId, 
                    name: 'æˆ¿ä¸»', 
                    isHost: true,
                    role: null,
                    faction: null,
                    status: 'alive',
                    isJoined: true
                }
            ];
            
            // æ·»åŠ ç©ºä½
            updatePlayerSlots();
            
            // ç”Ÿæˆåˆ†äº«é“¾æ¥
            updateRoomLink();
            
            // åŠ è½½ä¿å­˜çš„æ•°æ®
            loadSavedData();
        }

        // æ›´æ–°ç©å®¶ç©ºä½
        function updatePlayerSlots() {
            const total = parseInt(document.getElementById('totalPlayers').value);
            gameData.settings.totalPlayers = total;
            
            // æ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆ
            const hostGrid = document.getElementById('hostPlayersGrid');
            hostGrid.innerHTML = '';
            
            const playerGrid = document.getElementById('playerWaitingGrid');
            playerGrid.innerHTML = '';
            
            // ç¡®ä¿æˆ¿ä¸»åœ¨ç¬¬ä¸€ä½
            gameData.players = gameData.players.filter(p => p.isHost);
            
            // æ·»åŠ ç©ºä½
            for (let i = 1; i < total; i++) {
                gameData.players.push({
                    id: `empty_${i}`,
                    name: `ç©ºä½ ${i}`,
                    isHost: false,
                    role: null,
                    faction: null,
                    status: 'waiting',
                    isJoined: false
                });
            }
            
            renderHostPlayers();
            renderPlayerWaiting();
        }

        // æ¸²æŸ“æˆ¿ä¸»è§†è§’ç©å®¶åˆ—è¡¨
        function renderHostPlayers() {
            const grid = document.getElementById('hostPlayersGrid');
            grid.innerHTML = '';
            
            gameData.players.forEach((player, index) => {
                const card = document.createElement('div');
                let cardClass = 'player-card';
                
                if (!player.isJoined) cardClass += ' empty';
                if (player.status === 'dead') cardClass += ' dead';
                if (player.id === gameData.challenger) cardClass += ' challenger';
                if (player.id === gameData.opponent) cardClass += ' opponent';
                
                card.className = cardClass;
                card.innerHTML = `
                    <div class="avatar"></div>
                    <div>${player.name}</div>
                    ${player.status === 'dead' ? '<div style="font-size:11px;color:#e74c3c;">âŒ æ·˜æ±°</div>' : ''}
                    ${player.status === 'alive' ? '<div style="font-size:11px;color:#2ecc71;">âœ… å­˜æ´»</div>' : ''}
                    <div style="font-size:10px;margin-top:5px;">ç‚¹å‡»æ“ä½œ</div>
                `;
                
                card.onclick = () => selectPlayer(player.id);
                grid.appendChild(card);
            });
        }

        // æ¸²æŸ“ç©å®¶ç­‰å¾…ç•Œé¢
        function renderPlayerWaiting() {
            const grid = document.getElementById('playerWaitingGrid');
            grid.innerHTML = '';
            
            gameData.players.forEach(player => {
                if (player.isJoined) {
                    const card = document.createElement('div');
                    card.className = 'player-card';
                    card.innerHTML = `
                        <div class="avatar"></div>
                        <div>${player.name}</div>
                        ${player.isHost ? '<div style="font-size:11px;">ğŸ‘‘ æˆ¿ä¸»</div>' : '<div style="font-size:11px;">ç©å®¶</div>'}
                    `;
                    grid.appendChild(card);
                }
            });
        }

        // é€‰æ‹©ç©å®¶ï¼ˆæˆ¿ä¸»æ“ä½œï¼‰
        function selectPlayer(playerId) {
            const player = gameData.players.find(p => p.id === playerId);
            if (!player || player.status === 'dead' || !player.isJoined) return;
            
            // æ ¹æ®å½“å‰çŠ¶æ€é€‰æ‹©æ“ä½œ
            if (!gameData.challenger) {
                gameData.challenger = playerId;
                logMessage(`è®¾ç½® ${player.name} ä¸ºæ“‚ä¸»`);
            } else if (!gameData.opponent && playerId !== gameData.challenger) {
                gameData.opponent = playerId;
                logMessage(`è®¾ç½® ${player.name} ä¸ºå¯¹æ‰‹ï¼Œå¯¹å†³å¼€å§‹ï¼`);
                document.getElementById('winBtn').disabled = false;
                document.getElementById('loseBtn').disabled = false;
            }
            
            renderHostPlayers();
            updatePlayerViews();
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            const wolfCount = parseInt(document.getElementById('wolfCount').value);
            const dogCount = parseInt(document.getElementById('dogCount').value);
            const neutralCount = parseInt(document.getElementById('neutralCount').value);
            
            // éªŒè¯äººæ•°
            if (wolfCount + dogCount + neutralCount !== gameData.settings.totalPlayers) {
                alert(`æ€»äººæ•°ä¸åŒ¹é…ï¼è¯·æ£€æŸ¥è®¾ç½®ã€‚\nç‹¼${wolfCount} + ç‹—${dogCount} + ä¸­ç«‹${neutralCount} = ${wolfCount + dogCount + neutralCount}\nä½†æ€»ç©å®¶æ•°æ˜¯ ${gameData.settings.totalPlayers}`);
                return;
            }
            
            // åˆ†é…è§’è‰²
            assignRoles(wolfCount, dogCount, neutralCount);
            
            gameData.gameStarted = true;
            logMessage(`æ¸¸æˆå¼€å§‹ï¼é…ç½®ï¼šç‹¼${wolfCount} ç‹—${dogCount} ä¸­ç«‹${neutralCount}`);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('startBtn').disabled = true;
            document.getElementById('challengerBtn').disabled = false;
            document.getElementById('opponentBtn').disabled = false;
            
            // åˆ‡æ¢åˆ°ç©å®¶ç•Œé¢æ˜¾ç¤ºæ¸¸æˆçŠ¶æ€
            switchTab('player');
            updatePlayerViews();
        }

        // åˆ†é…è§’è‰²
        function assignRoles(wolfCount, dogCount, neutralCount) {
            // è¿‡æ»¤å‡ºå·²åŠ å…¥çš„ç©å®¶
            const joinedPlayers = gameData.players.filter(p => p.isJoined);
            
            // å‡†å¤‡è§’è‰²æ± 
            let rolesToAssign = [];
            
            // ç‹¼æ´¾è§’è‰²
            const wolfRoles = rolePool.filter(r => r.faction === 'wolf');
            for (let i = 0; i < wolfCount; i++) {
                rolesToAssign.push(wolfRoles[i % wolfRoles.length]);
            }
            
            // ç‹—æ´¾è§’è‰²
            const dogRoles = rolePool.filter(r => r.faction === 'dog');
            for (let i = 0; i < dogCount; i++) {
                rolesToAssign.push(dogRoles[i % dogRoles.length]);
            }
            
            // ä¸­ç«‹è§’è‰²
            const neutralRoles = rolePool.filter(r => r.faction === 'neutral');
            for (let i = 0; i < neutralCount; i++) {
                rolesToAssign.push(neutralRoles[i % neutralRoles.length]);
            }
            
            // æ‰“ä¹±é¡ºåº
            rolesToAssign = shuffleArray(rolesToAssign);
            
            // åˆ†é…ç»™ç©å®¶
            joinedPlayers.forEach((player, index) => {
                if (index < rolesToAssign.length) {
                    player.role = rolesToAssign[index].name;
                    player.faction = rolesToAssign[index].faction;
                    player.skill = rolesToAssign[index].skill;
                    player.color = rolesToAssign[index].color;
                }
            });
        }

        // æ“‚å°èƒœåˆ©
        function challengerWins() {
            if (!gameData.opponent) return;
            
            const challenger = gameData.players.find(p => p.id === gameData.challenger);
            const opponent = gameData.players.find(p => p.id === gameData.opponent);
            
            opponent.status = 'dead';
            logMessage(`${challenger.name} çŒœç èƒœåˆ©ï¼${opponent.name} è¢«æ·˜æ±°`);
            
            // é‡ç½®å¯¹æ‰‹ï¼Œæ“‚ä¸»ç»§ç»­
            gameData.opponent = null;
            
            checkGameEnd();
            renderHostPlayers();
            updatePlayerViews();
        }

        // å¯¹æ‰‹èƒœåˆ©
        function opponentWins() {
            if (!gameData.opponent) return;
            
            const challenger = gameData.players.find(p => p.id === gameData.challenger);
            const opponent = gameData.players.find(p => p.id === gameData.opponent);
            
            challenger.status = 'dead';
            logMessage(`${opponent.name} çŒœç èƒœåˆ©ï¼${challenger.name} è¢«æ·˜æ±°`);
            
            // å¯¹æ‰‹æˆä¸ºæ–°æ“‚ä¸»
            gameData.challenger = gameData.opponent;
            gameData.opponent = null;
            
            checkGameEnd();
            renderHostPlayers();
            updatePlayerViews();
        }

        // æ£€æŸ¥æ¸¸æˆç»“æŸ
        function checkGameEnd() {
            const alivePlayers = gameData.players.filter(p => p.status === 'alive' && p.isJoined);
            const factions = [...new Set(alivePlayers.map(p => p.faction))];
            
            if (factions.length === 1 && factions[0]) {
                const factionNames = { wolf: 'ç‹¼æ´¾', dog: 'ç‹—æ´¾', neutral: 'ä¸­ç«‹' };
                logMessage(`ğŸ‰ æ¸¸æˆç»“æŸï¼${factionNames[factions[0]]} è·èƒœï¼`);
                
                document.getElementById('winBtn').disabled = true;
                document.getElementById('loseBtn').disabled = true;
            }
        }

        // æ›´æ–°æ‰€æœ‰ç©å®¶è§†å›¾
        function updatePlayerViews() {
            // æ›´æ–°ç©å®¶ç•Œé¢
            if (gameData.gameStarted) {
                document.getElementById('playerWaiting').style.display = 'none';
                document.getElementById('playerGame').style.display = 'block';
                
                // å‡è®¾å½“å‰æŸ¥çœ‹çš„æ˜¯ç¬¬ä¸€ä¸ªç©å®¶ï¼ˆéæˆ¿ä¸»ï¼‰
                const player = gameData.players.find(p => !p.isHost && p.isJoined);
                if (player) {
                    document.getElementById('myName').textContent = player.name;
                    document.getElementById('myRole').textContent = `è§’è‰²: ${player.role || 'æœªåˆ†é…'}`;
                    document.getElementById('myFaction').textContent = `é˜µè¥: ${player.faction || 'æœªåˆ†é…'}`;
                    
                    // å¦‚æœæ˜¯ç‹¼æ´¾ï¼Œæ˜¾ç¤ºé˜Ÿå‹
                    const wolfTeammatesGrid = document.getElementById('wolfTeammatesGrid');
                    if (player.faction === 'wolf') {
                        wolfTeammatesGrid.style.display = 'block';
                        const teammates = gameData.players.filter(p => 
                            p.faction === 'wolf' && p.id !== player.id && p.isJoined
                        );
                        
                        wolfTeammatesGrid.innerHTML = '';
                        teammates.forEach(teammate => {
                            const card = document.createElement('div');
                            card.className = 'player-card';
                            card.innerHTML = `
                                <div class="avatar" style="background: ${teammate.color || '#c0392b'}"></div>
                                <div>${teammate.name}</div>
                                <div style="font-size:11px;">${teammate.role}</div>
                                <button class="small" onclick="alert('æŠ€èƒ½: ${teammate.skill || 'æ— '}')">æŸ¥çœ‹æŠ€èƒ½</button>
                            `;
                            wolfTeammatesGrid.appendChild(card);
                        });
                    } else {
                        wolfTeammatesGrid.style.display = 'none';
                    }
                    
                    // æ›´æ–°å­˜æ´»å’Œæ·˜æ±°åˆ—è¡¨
                    updatePlayerAliveDeadLists();
                }
            }
            
            // åŒæ­¥æ—¥å¿—
            const playerLog = document.getElementById('playerLog');
            playerLog.innerHTML = document.getElementById('gameLog').innerHTML;
        }

        // æ›´æ–°ç©å®¶å­˜æ´»/æ·˜æ±°åˆ—è¡¨
        function updatePlayerAliveDeadLists() {
            const aliveGrid = document.getElementById('playerAliveGrid');
            const deadGrid = document.getElementById('playerDeadGrid');
            
            aliveGrid.innerHTML = '';
            deadGrid.innerHTML = '';
            
            gameData.players.forEach(player => {
                if (!player.isJoined) return;
                
                const card = document.createElement('div');
                card.className = `player-card ${player.status === 'dead' ? 'dead' : ''}`;
                card.innerHTML = `
                    <div class="avatar"></div>
                    <div>${player.name}</div>
                    ${player.status === 'alive' ? '<div style="font-size:11px;color:#2ecc71;">âœ… å­˜æ´»</div>' : ''}
                    ${player.status === 'dead' ? '<div style="font-size:11px;color:#e74c3c;">âŒ æ·˜æ±°</div>' : ''}
                `;
                
                if (player.status === 'alive') {
                    aliveGrid.appendChild(card);
                } else {
                    deadGrid.appendChild(card);
                }
            });
        }

        // åº”ç”¨é¢„è®¾
        function applyPreset(presetName) {
            const presets = {
                '6äººç»å…¸': { total: 6, wolf: 2, dog: 3, neutral: 1 },
                '8äººå±€': { total: 8, wolf: 2, dog: 4, neutral: 2 },
                '10äººå±€': { total: 10, wolf: 3, dog: 5, neutral: 2 }
            };
            
            const preset = presets[presetName];
            if (preset) {
                document.getElementById('totalPlayers').value = preset.total;
                document.getElementById('wolfCount').value = preset.wolf;
                document.getElementById('dogCount').value = preset.dog;
                document.getElementById('neutralCount').value = preset.neutral;
                
                updatePlayerSlots();
                logMessage(`å·²åº”ç”¨é¢„è®¾: ${presetName}`);
            }
        }

        // æ—¥å¿—
        function logMessage(message) {
            const logDiv = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // ä¿å­˜åˆ°æ¸¸æˆæ•°æ®
            gameData.log.push(entry.textContent);
            saveGameData();
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // ç§»é™¤æ‰€æœ‰activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡æ ‡ç­¾é¡µ
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // æ¿€æ´»å¯¹åº”æ ‡ç­¾
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes(tabName === 'host' ? 'æˆ¿ä¸»' : tabName === 'player' ? 'ç©å®¶' : 'ç®¡ç†')) {
                    tab.classList.add('active');
                }
            });
            
            // å¦‚æœæ˜¯ç©å®¶ç•Œé¢ï¼Œæ›´æ–°è§†å›¾
            if (tabName === 'player') {
                updatePlayerViews();
            }
            
            // å¦‚æœæ˜¯ç®¡ç†ç•Œé¢ï¼ŒåŠ è½½æ•°æ®
            if (tabName === 'admin') {
                loadAdminData();
            }
        }

        // å¤åˆ¶é“¾æ¥
        function copyLink() {
            const linkInput = document.getElementById('roomLink');
            linkInput.select();
            document.execCommand('copy');
            alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }

        // æŸ¥çœ‹è§’è‰²å¡
        function viewMyCard() {
            const player = gameData.players.find(p => !p.isHost && p.isJoined);
            if (player && player.role) {
                const role = rolePool.find(r => r.name === player.role);
                if (role) {
                    document.getElementById('roleName').textContent = role.name;
                    document.getElementById('roleFaction').textContent = `é˜µè¥ï¼š${role.faction === 'wolf' ? 'ç‹¼æ´¾' : role.faction === 'dog' ? 'ç‹—æ´¾' : 'ä¸­ç«‹'}`;
                    document.getElementById('roleSkill').textContent = `æŠ€èƒ½ï¼š${role.skill}`;
                    document.getElementById('roleImg').style.background = role.color;
                    document.getElementById('roleModal').style.display = 'flex';
                }
            }
        }

        // å…³é—­è§’è‰²å¡
        function closeRoleModal() {
            document.getElementById('roleModal').style.display = 'none';
        }

        // ä¿å­˜æ¸¸æˆæ•°æ®
        function saveGameData() {
            localStorage.setItem('wolfdog_game_data', JSON.stringify(gameData));
        }

        // åŠ è½½æ¸¸æˆæ•°æ®
        function loadSavedData() {
            const saved = localStorage.getItem('wolfdog_game_data');
            if (saved) {
                Object.assign(gameData, JSON.parse(saved));
                renderHostPlayers();
                renderPlayerWaiting();
                
                // æ¢å¤æ—¥å¿—
                const logDiv = document.getElementById('gameLog');
                logDiv.innerHTML = '';
                gameData.log.forEach(msg => {
                    const entry = document.createElement('div');
                    entry.textContent = msg;
                    logDiv.appendChild(entry);
                });
            }
        }

        // ç®¡ç†ç•Œé¢åŠŸèƒ½
        function loadAdminData() {
            const rolesList = document.getElementById('rolesList');
            rolesList.innerHTML = '';
            
            rolePool.forEach(role => {
                const roleDiv = document.createElement('div');
                roleDiv.className = 'setting-item';
                roleDiv.innerHTML = `
                    <input type="text" value="${role.name}" onchange="updateRole(${role.id}, 'name', this.value)" style="width:100px;">
                    <select onchange="updateRole(${role.id}, 'faction', this.value)" style="margin:0 10px;">
                        <option value="wolf" ${role.faction === 'wolf' ? 'selected' : ''}>ç‹¼æ´¾</option>
                        <option value="dog" ${role.faction === 'dog' ? 'selected' : ''}>ç‹—æ´¾</option>
                        <option value="neutral" ${role.faction === 'neutral' ? 'selected' : ''}>ä¸­ç«‹</option>
                    </select>
                    <input type="text" value="${role.skill}" onchange="updateRole(${role.id}, 'skill', this.value)" style="width:300px;">
                    <input type="color" value="${role.color}" onchange="updateRole(${role.id}, 'color', this.value)" style="width:50px;">
                `;
                rolesList.appendChild(roleDiv);
            });
        }

        function updateRole(id, field, value) {
            const role = rolePool.find(r => r.id === id);
            if (role) {
                role[field] = value;
            }
        }

        function addNewRole() {
            const newId = Math.max(...rolePool.map(r => r.id)) + 1;
            rolePool.push({
                id: newId,
                name: 'æ–°è§’è‰²',
                faction: 'wolf',
                skill: 'æ–°æŠ€èƒ½',
                color: '#3498db'
            });
            loadAdminData();
        }

        function saveAdminData() {
            localStorage.setItem('wolfdog_role_pool', JSON.stringify(rolePool));
            localStorage.setItem('wolfdog_bg_image', document.getElementById('bgImageUrl').value);
            localStorage.setItem('wolfdog_sound_start', document.getElementById('soundStart').value);
            alert('ç®¡ç†æ•°æ®å·²ä¿å­˜ï¼');
        }

        // å·¥å…·å‡½æ•°
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // æ›´æ–°æˆ¿é—´é“¾æ¥
        function updateRoomLink() {
            const baseUrl = window.location.href.split('?')[0];
            const link = baseUrl + '?room=' + gameData.roomId + '&player=1';
            document.getElementById('roomLink').value = link;
        }

        // é¡µé¢åŠ è½½
        window.onload = function() {
            init();
        };
    </script>
</body>
</html>